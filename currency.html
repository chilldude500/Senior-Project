// commiting 
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Currency Leaderboard</title>
  <style>
    body { font-family: Arial, sans-serif; background:#9fd3e5; margin:0; }
    .wrap { display:flex; justify-content:center; margin-top:80px; }
    .card { background:#fff; width:820px; padding:30px; border-radius:12px; box-shadow:0 4px 18px rgba(0,0,0,.15); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input, select, button { padding:10px; font-size:14px; border-radius:8px; border:1px solid #ccc; }
    button { background:#4CAF50; border:none; color:white; cursor:pointer; padding:10px 18px; }
    table { width:100%; border-collapse:collapse; margin-top:18px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; }
    th { background:#f5f5f5; }
    .muted { color:#444; margin-top:10px; }
    a { display:inline-block; margin-top:18px; color:#000; text-decoration:none; }
    .small { font-size: 12px; color:#555; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Currency Leaderboard</h2>
      <div class="small">Compares how far your home currency goes across countries (simple purchasing power proxy).</div>

      <div class="row" style="margin-top:14px;">
        <select id="base" style="min-width:160px;"></select>
        <input id="amount" type="number" min="1" value="100" style="min-width:160px;" />
        <button id="seed">Seed Currencies</button>
        <button id="btn">Load Leaderboard</button>
      </div>

      <div id="status" class="muted"></div>

      <table id="tbl" style="display:none;">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Country</th>
            <th>Currency</th>
            <th>Local Amount</th>
            <th>Cost Index</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>

      <a href="/">Back to Main Page</a>
    </div>
  </div>

<script>
  async function seedCurrencies() {
    document.getElementById('status').textContent = 'Seeding currencies...';
    const resp = await fetch('/api/currency/seed', { method: 'POST' });
    const data = await resp.json();
    if (!data.ok) {
      document.getElementById('status').textContent = data.message || 'Seed failed';
      return;
    }
    document.getElementById('status').textContent = 'Seed complete. Now loading dropdown...';
    await loadDropdown();
    document.getElementById('status').textContent = 'Ready.';
  }

  async function loadDropdown() {
    // Load leaderboard once to get codes (or you could add a dedicated endpoint later)
    const resp = await fetch('/api/currency/leaderboard?base=USD&amount=1&top=200');
    const data = await resp.json();

    const baseSel = document.getElementById('base');
    baseSel.innerHTML = '';

    // If no data yet, just show USD
    if (!data.ok || !Array.isArray(data.results) || data.results.length === 0) {
      baseSel.innerHTML = `<option value="USD">USD</option>`;
      return;
    }

    const codes = [...new Set(data.results.map(r => r.currencyCode))].sort();
    for (const code of codes) {
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = code;
      if (code === 'USD') opt.selected = true;
      baseSel.appendChild(opt);
    }
  }

  async function loadLeaderboard() {
    const base = document.getElementById('base').value;
    const amount = document.getElementById('amount').value;

    document.getElementById('status').textContent = 'Loading leaderboard...';
    document.getElementById('tbl').style.display = 'none';
    document.getElementById('body').innerHTML = '';

    const params = new URLSearchParams();
    params.set('base', base);
    params.set('amount', amount);
    params.set('top', '50');

    const resp = await fetch('/api/currency/leaderboard?' + params.toString());
    const data = await resp.json();

    if (!data.ok) {
      document.getElementById('status').textContent = data.message || 'Load failed';
      return;
    }

    document.getElementById('status').textContent =
      `Base: ${data.base}, Amount: ${data.amount} (${data.usdAmount} USD). Showing top ${data.results.length}.`;

    document.getElementById('tbl').style.display = 'table';

    data.results.forEach((r, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${escapeHtml(r.country)}</td>
        <td>${escapeHtml(r.currencyCode)} ${escapeHtml(r.currencyName || '')}</td>
        <td>${Number(r.localAmount).toLocaleString()}</td>
        <td>${Number(r.costIndex).toFixed(0)}</td>
        <td>${Number(r.purchasingPowerScore).toFixed(6)}</td>
      `;
      document.getElementById('body').appendChild(tr);
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  document.getElementById('seed').addEventListener('click', seedCurrencies);
  document.getElementById('btn').addEventListener('click', loadLeaderboard);

  // init
  loadDropdown();
</script>
</body>
</html>
